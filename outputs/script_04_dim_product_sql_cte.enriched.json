{
  "script_name": "script_04_dim_product_sql_cte.py",
  "dataframes": [],
  "assets": {
    "reads": [],
    "writes": []
  },
  "bedrock_enrichment": {
    "group_by": [],
    "aggregations": [],
    "derived_columns": [],
    "joins": [],
    "sql_blocks": [
      {
        "name": "cleaned",
        "sql": "WITH cleaned AS (SELECT CAST(product_id AS STRING) AS product_id, LOWER(TRIM(category)) AS category, CAST(price AS DOUBLE) AS price, CAST(cost AS DOUBLE) AS cost, UPPER(COALESCE(currency, 'USD')) AS currency, TO_DATE(updated_at) AS updated_date, CASE WHEN price IS NULL OR price <= 0 THEN 0 ELSE price END AS price_norm FROM raw_products)",
        "tables": [
          "raw_products"
        ],
        "columns": [
          "product_id",
          "category",
          "price",
          "cost",
          "currency",
          "updated_at",
          "price_norm"
        ]
      },
      {
        "name": "metrics",
        "sql": "SELECT product_id, category, currency, updated_date, price_norm, cost, (price_norm - cost) AS unit_margin, CASE WHEN price_norm = 0 THEN NULL ELSE (price_norm - cost)/price_norm END AS margin_pct FROM cleaned",
        "tables": [
          "cleaned"
        ],
        "columns": [
          "product_id",
          "category",
          "currency",
          "updated_date",
          "price_norm",
          "cost",
          "unit_margin",
          "margin_pct"
        ]
      }
    ]
  },
  "enriched_from": {
    "script": "examples/script_04_dim_product_sql_cte.py",
    "base_json": "outputs/script_04_dim_product_sql_cte.json",
    "model_id": "amazon.nova-lite-v1:0",
    "region": "us-east-1"
  }
}